<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --status-red: #FF4444;
            --status-yellow: #FFBB33;
            --status-green: #00C851;
        }

        body {
            background: #f8f9fa;
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, #4472C4 0%, #2E5090 100%);
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        .card-header {
            background: white;
            border-bottom: 1px solid #eee;
            font-weight: 600;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
        }

        .status-red {
            background: var(--status-red);
            color: white;
        }

        .status-yellow {
            background: var(--status-yellow);
            color: #333;
        }

        .status-green {
            background: var(--status-green);
            color: white;
        }

        .traffic-light {
            display: flex;
            gap: 8px;
            margin: 20px 0;
        }

        .traffic-light .light {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #4472C4;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #4472C4;
            background: #e8f0ff;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .results-table td {
            vertical-align: middle;
        }

        .resource-link {
            display: inline-block;
            padding: 4px 12px;
            background: #f0f0f0;
            border-radius: 6px;
            text-decoration: none;
            color: #333;
            font-size: 13px;
            margin: 2px;
            transition: all 0.2s;
        }

        .resource-link:hover {
            background: #4472C4;
            color: white;
        }

        .progress-indicator {
            display: none;
        }

        .progress-indicator.active {
            display: block;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
        }

        .stat-card .number {
            font-size: 48px;
            font-weight: 700;
            line-height: 1;
        }

        .stat-card .label {
            color: #666;
            margin-top: 8px;
        }

        .stat-card.red .number { color: var(--status-red); }
        .stat-card.yellow .number { color: var(--status-yellow); }
        .stat-card.green .number { color: var(--status-green); }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .tab-content {
            padding-top: 20px;
        }

        .quick-check-form {
            max-width: 600px;
            margin: 0 auto;
        }

        #resultsContainer {
            display: none;
        }

        #resultsContainer.show {
            display: block;
        }

        .factor-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin: 2px;
        }

        .factor-red { background: #ffebee; color: #c62828; }
        .factor-yellow { background: #fff8e1; color: #f57f17; }
        .factor-green { background: #e8f5e9; color: #2e7d32; }

        .spinner-border {
            width: 1rem;
            height: 1rem;
        }

        .mktu-select {
            max-height: 200px;
            overflow-y: auto;
        }

        .mktu-checkbox {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
        }

        .mktu-checkbox:hover {
            background: #f0f0f0;
        }

        .mktu-checkbox input {
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-check me-2"></i>
                –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
            </a>
            <div class="d-flex align-items-center text-white gap-2">
                <a href="/history" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-clock-history me-1"></i> –ò—Å—Ç–æ—Ä–∏—è
                </a>
                <a href="/api/template" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-download me-1"></i> –®–∞–±–ª–æ–Ω
                </a>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <!-- –õ–µ–≥–µ–Ω–¥–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ -->
        <div class="card mb-4">
            <div class="card-body">
                <h6 class="mb-3"><i class="bi bi-info-circle me-2"></i></h6>
                <div class="row">
                    <div class="col-md-4">
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--status-red);"></div>
                            <div>
                                <strong>–ö–†–ê–°–ù–´–ô</strong><br>
                                <small class="text-muted">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ. –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –ø—Ä–µ—Ç–µ–Ω–∑–∏–π.</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--status-yellow);"></div>
                            <div>
                                <strong>–ñ–ï–õ–¢–´–ô</strong><br>
                                <small class="text-muted">–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞.</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--status-green);"></div>
                            <div>
                                <strong>–ó–ï–õ–ï–ù–´–ô</strong><br>
                                <small class="text-muted">–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å. –†–∏—Å–∫–æ–≤ –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±—ã -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="quick-tab" data-bs-toggle="tab" data-bs-target="#quick" type="button">
                    <i class="bi bi-search me-1"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è (—Å–ª–æ–≤–µ—Å–Ω–æ–≥–æ –∑–Ω–∞–∫–∞)
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="batch-tab" data-bs-toggle="tab" data-bs-target="#batch" type="button">
                    <i class="bi bi-image me-1"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="batch-multi-tab" data-bs-toggle="tab" data-bs-target="#batchMulti" type="button">
                    <i class="bi bi-images me-1"></i> –ü–∞–∫–µ—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button">
                    <i class="bi bi-link-45deg me-1"></i> –†–µ—Å—É—Ä—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ -->
            <div class="tab-pane fade show active" id="quick" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-search me-2"></i>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≤–∞—Ä–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
                    </div>
                    <div class="card-body">
                        <form id="quickCheckForm" class="quick-check-form">
                            <div class="mb-3">
                                <label class="form-label">–¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ *</label>
                                <input type="text" class="form-control form-control-lg" id="checkText"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Å–ª–æ–≥–∞–Ω –∏–ª–∏ —Ç–µ–∫—Å—Ç —Å —Ç–æ–≤–∞—Ä–∞" required>
                                <div class="form-text">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ —Ç–æ–≤–∞—Ä–µ</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">–ö–ª–∞—Å—Å—ã –ú–ö–¢–£</label>
                                <div class="mktu-select border rounded p-2">
                                    {% for class_num, class_name in mktu_classes.items() %}
                                    <label class="mktu-checkbox">
                                        <input type="checkbox" name="mktu" value="{{ class_num }}">
                                        <span>{{ class_num }} - {{ class_name }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å—ã —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="bi bi-search me-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                            </button>
                        </form>

                        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
                        <div id="quickResults" class="mt-4" style="display: none;">
                            <hr>
                            <h5>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏</h5>

                            <div id="quickResultsContent"></div>

                            <div class="mt-4">
                                <h6>–°—Å—ã–ª–∫–∏ –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:</h6>
                                <div id="manualCheckLinks"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é -->
            <div class="tab-pane fade" id="batch" role="tabpanel">
                <div class="row">
                    <div class="col-md-8 mx-auto mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="bi bi-image me-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                            </div>
                            <div class="card-body">
                                <div class="upload-area" id="imageUploadArea">
                                    <i class="bi bi-images" style="font-size: 48px; color: #ccc;"></i>
                                    <p class="mt-3 mb-0">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—é–¥–∞</p>
                                    <p class="text-muted">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                                    <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                                </div>
                                <div id="imagePreviewArea" style="display: none;" class="mt-3">
                                    <img id="imagePreview" src="" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                                    <div class="mt-2">
                                        <input type="text" class="form-control form-control-sm" id="imageManualText"
                                               placeholder="–¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                                    </div>
                                    <div class="mt-2">
                                        <select class="form-select form-select-sm" id="imageMktuClass">
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –ú–ö–¢–£ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</option>
                                            {% for code, name in mktu_classes.items() %}
                                            <option value="{{ code }}">{{ code }} - {{ name[:50] }}...</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <button class="btn btn-primary mt-2 w-100" onclick="checkSingleImage()">
                                        <i class="bi bi-search me-1"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
                <div id="batchProgress" class="card mb-4" style="display: none;">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-primary me-3" role="status"></div>
                            <div>
                                <strong>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞...</strong>
                                <div class="progress mt-2" style="width: 300px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                                         id="batchProgressBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                <div id="imageCheckResults" class="card mb-4" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-image me-2"></i>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="closeImageResults()">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Å—Ç–∞—Ç—É—Å -->
                            <div class="col-md-4">
                                <img id="resultImagePreview" src="" alt="Image" class="img-fluid rounded mb-3" style="max-height: 250px;">
                                <div id="imageOverallStatus" class="alert mb-3">
                                    <!-- –°—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </div>
                                <div id="imageSummaryStats" class="small text-muted mb-3">
                                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                </div>
                                <!-- –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
                                <div id="imageExportButtons" class="d-flex gap-2" style="display: none;">
                                    <button class="btn btn-sm btn-success" onclick="exportImageReport('excel')">
                                        <i class="bi bi-file-earmark-excel me-1"></i>Excel
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="exportImageReport('pdf')">
                                        <i class="bi bi-file-earmark-pdf me-1"></i>PDF
                                    </button>
                                </div>
                            </div>

                            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¥–µ—Ç–∞–ª–∏ -->
                            <div class="col-md-8">
                                <!-- –í–∫–ª–∞–¥–∫–∏ -->
                                <ul class="nav nav-tabs" id="imageResultTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="tm-tab" data-bs-toggle="tab"
                                                data-bs-target="#tmResults" type="button">
                                            <i class="bi bi-search"></i> –¢–æ–≤–∞—Ä–Ω—ã–µ –∑–Ω–∞–∫–∏
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="ocr-tab" data-bs-toggle="tab"
                                                data-bs-target="#ocrResults" type="button">
                                            <i class="bi bi-fonts"></i> –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="links-tab" data-bs-toggle="tab"
                                                data-bs-target="#searchLinks" type="button">
                                            <i class="bi bi-link-45deg"></i> –ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="rec-tab" data-bs-toggle="tab"
                                                data-bs-target="#recommendations" type="button">
                                            <i class="bi bi-lightbulb"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                                        </button>
                                    </li>
                                </ul>

                                <div class="tab-content p-3 border border-top-0 rounded-bottom" id="imageResultTabContent">
                                    <!-- –¢–æ–≤–∞—Ä–Ω—ã–µ –∑–Ω–∞–∫–∏ -->
                                    <div class="tab-pane fade show active" id="tmResults" role="tabpanel">
                                        <div id="tmResultsContent">
                                            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¢–ó –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                        </div>
                                    </div>

                                    <!-- –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç -->
                                    <div class="tab-pane fade" id="ocrResults" role="tabpanel">
                                        <div id="ocrResultsContent">
                                            <!-- OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                        </div>
                                    </div>

                                    <!-- –°—Å—ã–ª–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ -->
                                    <div class="tab-pane fade" id="searchLinks" role="tabpanel">
                                        <p class="text-muted mb-3">–í—ã–ø–æ–ª–Ω–∏—Ç–µ –æ–±—Ä–∞—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</p>
                                        <div id="searchLinksContent" class="d-flex flex-wrap gap-2">
                                            <!-- –°—Å—ã–ª–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                        </div>
                                        <hr>
                                        <p class="text-muted mb-3">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≤–∞—Ä–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤:</p>
                                        <div id="tmLinksContent" class="d-flex flex-wrap gap-2">
                                            <!-- –°—Å—ã–ª–∫–∏ –¢–ó –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                        </div>
                                    </div>

                                    <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
                                    <div class="tab-pane fade" id="recommendations" role="tabpanel">
                                        <div id="recommendationsContent">
                                            <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="resultsContainer">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body stat-card">
                                    <div class="number" id="statTotal">0</div>
                                    <div class="label">–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body stat-card red">
                                    <div class="number" id="statRed">0</div>
                                    <div class="label">–ó–∞–ø—Ä–µ—â–µ–Ω–æ</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body stat-card yellow">
                                    <div class="number" id="statYellow">0</div>
                                    <div class="label">–¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body stat-card green">
                                    <div class="number" id="statGreen">0</div>
                                    <div class="label">–†–∞–∑—Ä–µ—à–µ–Ω–æ</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="d-flex gap-2">
                                <button class="btn btn-success" onclick="exportResults('excel')">
                                    <i class="bi bi-file-earmark-excel me-1"></i>–°–∫–∞—á–∞—Ç—å Excel
                                </button>
                                <button class="btn btn-outline-secondary" onclick="exportResults('csv')">
                                    <i class="bi bi-filetype-csv me-1"></i>CSV
                                </button>
                                <button class="btn btn-outline-secondary" onclick="exportResults('html')">
                                    <i class="bi bi-filetype-html me-1"></i>HTML
                                </button>
                                <button class="btn btn-outline-secondary" onclick="exportResults('json')">
                                    <i class="bi bi-filetype-json me-1"></i>JSON
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-table me-2"></i>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏</span>
                            <div>
                                <select class="form-select form-select-sm" id="filterStatus" style="width: auto;">
                                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                    <option value="red">–¢–æ–ª—å–∫–æ –∫—Ä–∞—Å–Ω—ã–µ</option>
                                    <option value="yellow">–¢–æ–ª—å–∫–æ –∂–µ–ª—Ç—ã–µ</option>
                                    <option value="green">–¢–æ–ª—å–∫–æ –∑–µ–ª–µ–Ω—ã–µ</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover results-table mb-0">
                                    <thead>
                                        <tr>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                            <th>–û—Ü–µ–Ω–∫–∞</th>
                                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                            <th>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultsTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü–∞–∫–µ—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π) -->
            <div class="tab-pane fade" id="batchMulti" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-folder me-2"></i>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ –ø–∞–ø–∫–∏
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç Excel-–æ—Ç—á—ë—Ç.</p>

                        <!-- –°–ø–æ—Å–æ–± 1: –í—ã–±–æ—Ä –ø–∞–ø–∫–∏ —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥ -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">–°–ø–æ—Å–æ–± 1: –í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É</label>
                            <div class="d-flex gap-2">
                                <div class="upload-area flex-grow-1 py-3" id="folderSelectArea" style="cursor: pointer;">
                                    <i class="bi bi-folder2-open me-2" style="font-size: 24px; color: #4472C4;"></i>
                                    <span>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–∞–ø–∫–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏</span>
                                    <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;">
                                </div>
                            </div>
                            <div id="selectedFolderInfo" class="mt-2 text-success" style="display: none;">
                                <i class="bi bi-check-circle me-1"></i>
                                <span id="selectedFolderName"></span>
                            </div>
                        </div>

                        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
                        <input type="hidden" id="folderPath" value="">

                        <div class="d-grid mt-3">
                            <button class="btn btn-primary btn-lg" onclick="checkFolderImages()">
                                <i class="bi bi-search me-1"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            </button>
                        </div>
                        <div id="folderProgress" class="mt-3" style="display: none;">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                <span id="folderProgressText">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏...</span>
                            </div>
                            <div class="progress mt-2" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     id="folderProgressBar" style="width: 0%">0%</div>
                            </div>
                        </div>
                        <div id="folderResults" class="mt-3" style="display: none;">
                            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞–ø–∫–∏ -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-images me-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="multiImageUploadArea">
                            <i class="bi bi-cloud-upload" style="font-size: 48px; color: #ccc;"></i>
                            <p class="mt-3 mb-0">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å—é–¥–∞</p>
                            <p class="text-muted">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ (–¥–æ 10 —Ñ–∞–π–ª–æ–≤)</p>
                            <input type="file" id="multiImageFileInput" accept="image/*" multiple style="display: none;">
                        </div>
                        <div id="multiImagePreviewArea" class="mt-3 row g-2" style="display: none;">
                            <!-- –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        <div id="multiImageActions" class="mt-3" style="display: none;">
                            <button class="btn btn-primary" onclick="checkMultipleImages()">
                                <i class="bi bi-search me-1"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="clearMultipleImages()">
                                <i class="bi bi-x-lg me-1"></i>–û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                        </div>
                        <div id="multiImageResults" class="mt-4" style="display: none;">
                            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∞–∫–µ—Ç–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- –†–µ—Å—É—Ä—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
            <div class="tab-pane fade" id="resources" role="tabpanel">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="bi bi-bookmark-check me-2"></i>–ë–∞–∑—ã —Ç–æ–≤–∞—Ä–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤
                            </div>
                            <div class="card-body">
                                {% for key, resource in trademark_resources.items() %}
                                <div class="mb-3 pb-3 border-bottom">
                                    <h6>
                                        <a href="{{ resource.url }}" target="_blank">
                                            {{ resource.name }} <i class="bi bi-box-arrow-up-right small"></i>
                                        </a>
                                    </h6>
                                    <p class="text-muted small mb-1">{{ resource.description }}</p>
                                    {% if resource.limitations %}
                                    <span class="badge bg-warning text-dark">{{ resource.limitations }}</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="bi bi-image me-2"></i>–ü–æ–∏—Å–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                            </div>
                            <div class="card-body">
                                {% for key, resource in image_resources.items() %}
                                <div class="mb-3 pb-3 border-bottom">
                                    <h6>
                                        <a href="{{ resource.url }}" target="_blank">
                                            {{ resource.name }} <i class="bi bi-box-arrow-up-right small"></i>
                                        </a>
                                    </h6>
                                    <p class="text-muted small mb-0">{{ resource.description }}</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSessionId = null;
        let currentImageCheckId = null;  // ID —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞

        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        document.getElementById('quickCheckForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const text = document.getElementById('checkText').value;
            const mktuCheckboxes = document.querySelectorAll('input[name="mktu"]:checked');
            const mktuClasses = Array.from(mktuCheckboxes).map(cb => parseInt(cb.value));

            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>–ü—Ä–æ–≤–µ—Ä–∫–∞...';

            try {
                const response = await fetch('/api/check/single', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        text: text,
                        mktu_classes: mktuClasses
                    })
                });

                const data = await response.json();

                if (data.error) {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                    return;
                }

                displayQuickResults(data);

            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-search me-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
            }
        });

        function displayQuickResults(data) {
            const container = document.getElementById('quickResults');
            const content = document.getElementById('quickResultsContent');
            const links = document.getElementById('manualCheckLinks');

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            const statusClasses = {
                'red': 'status-red',
                'yellow': 'status-yellow',
                'green': 'status-green'
            };
            const statusLabels = {
                'red': '–ó–ê–ü–†–ï–©–ï–ù–û',
                'yellow': '–í–ù–ò–ú–ê–ù–ò–ï',
                'green': '–†–ê–ó–†–ï–®–ï–ù–û'
            };

            let html = `
                <div class="alert alert-${data.overall_status === 'red' ? 'danger' : data.overall_status === 'yellow' ? 'warning' : 'success'}">
                    <span class="status-badge ${statusClasses[data.overall_status]}">
                        ${statusLabels[data.overall_status]}
                    </span>
                </div>
            `;

            // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –¢–ó
            if (data.trademark_results && data.trademark_results.length > 0) {
                html += '<h6 class="mt-4">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≤–∞—Ä–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤:</h6>';
                data.trademark_results.forEach(r => {
                    html += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>${r.resource}</strong>
                                    <span class="status-badge ${statusClasses[r.status]}">${statusLabels[r.status]}</span>
                                </div>
                                <p class="text-muted small mb-2">${r.notes}</p>
                    `;

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                    if (r.matches && r.matches.length > 0) {
                        html += `
                            <div class="mt-2">
                                <small class="text-primary fw-bold">–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–Ω—ã–µ –∑–Ω–∞–∫–∏:</small>
                                <div class="table-responsive mt-1">
                                    <table class="table table-sm table-bordered mb-0" style="font-size: 12px;">
                                        <thead class="table-light">
                                            <tr>
                                                <th>‚Ññ —Å–≤–∏–¥.</th>
                                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ/–°–ª–æ–≤–∞</th>
                                                <th>–ú–ö–¢–£</th>
                                                <th>–°—Ç–∞—Ç—É—Å</th>
                                                <th>–°—Ö–æ–¥—Å—Ç–≤–æ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        r.matches.forEach(m => {
                            const similarity = m.similarity_score ? Math.round(m.similarity_score * 100) + '%' : '-';
                            const classes = Array.isArray(m.classes) ? m.classes.join(', ') : (m.classes || '-');
                            const statusTm = m.status || '-';
                            html += `
                                <tr>
                                    <td><strong>${m.registration_number || '-'}</strong></td>
                                    <td>${m.text || '-'}</td>
                                    <td>${classes}</td>
                                    <td><span class="badge ${statusTm === '–¥–µ–π—Å—Ç–≤—É–µ—Ç' ? 'bg-success' : 'bg-secondary'}">${statusTm}</span></td>
                                    <td>${similarity}</td>
                                </tr>
                            `;
                        });
                        html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }

                    html += `
                            </div>
                        </div>
                    `;
                });
            }

            content.innerHTML = html;

            // –°—Å—ã–ª–∫–∏ –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            if (data.manual_check_links) {
                let linksHtml = '';
                for (const [name, url] of Object.entries(data.manual_check_links)) {
                    linksHtml += `<a href="${url}" target="_blank" class="resource-link">${name}</a>`;
                }
                links.innerHTML = linksHtml;
            }

            container.style.display = 'block';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imageFileInput = document.getElementById('imageFileInput');
        let currentImageFile = null;

        imageUploadArea.addEventListener('click', () => imageFileInput.click());
        imageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadArea.classList.add('dragover');
        });
        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.classList.remove('dragover');
        });
        imageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                previewImage(e.dataTransfer.files[0]);
            }
        });

        imageFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                previewImage(e.target.files[0]);
            }
        });

        function previewImage(file) {
            currentImageFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreviewArea').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function checkSingleImage() {
            if (!currentImageFile) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                return;
            }

            const formData = new FormData();
            formData.append('file', currentImageFile);

            const manualText = document.getElementById('imageManualText').value;
            if (manualText) {
                formData.append('text', manualText);
            }

            const mktuClass = document.getElementById('imageMktuClass').value;
            if (mktuClass) {
                formData.append('mktu_classes', mktuClass);
            }

            document.getElementById('batchProgress').style.display = 'block';

            try {
                const response = await fetch('/api/check/image', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                document.getElementById('batchProgress').style.display = 'none';

                if (data.error) {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                    return;
                }

                displayImageCheckResults(data);

            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + error.message);
                document.getElementById('batchProgress').style.display = 'none';
            }
        }

        function displayImageCheckResults(data) {
            const resultsDiv = document.getElementById('imageCheckResults');
            resultsDiv.style.display = 'block';

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
            currentImageCheckId = data.check_id || null;
            const exportBtns = document.getElementById('imageExportButtons');
            if (currentImageCheckId && exportBtns) {
                exportBtns.style.display = 'flex';
            }

            // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.getElementById('resultImagePreview').src = document.getElementById('imagePreview').src;

            // –°—Ç–∞—Ç—É—Å
            const statusDiv = document.getElementById('imageOverallStatus');
            const statusConfig = {
                'red': { class: 'alert-danger', icon: 'üî¥', text: '–ó–ê–ü–†–ï–©–ï–ù–û', desc: '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è' },
                'yellow': { class: 'alert-warning', icon: 'üü°', text: '–í–ù–ò–ú–ê–ù–ò–ï', desc: '–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞' },
                'green': { class: 'alert-success', icon: 'üü¢', text: '–†–ê–ó–†–ï–®–ï–ù–û', desc: '–Ø–≤–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ' }
            };
            const status = statusConfig[data.overall_status] || statusConfig.yellow;
            statusDiv.className = `alert ${status.class}`;
            statusDiv.innerHTML = `<strong>${status.icon} ${status.text}</strong><br><small>${status.desc}</small>`;

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const summaryDiv = document.getElementById('imageSummaryStats');
            summaryDiv.innerHTML = `
                <div><strong>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ —Ç–µ–∫—Å—Ç–æ–≤:</strong> ${data.summary?.texts_found || 0}</div>
                <div><strong>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —Å–ª–æ–≤:</strong> ${data.summary?.texts_checked || 0}</div>
                <div><strong>–ü—Ä–æ–≤–µ—Ä–æ–∫ –¢–ó:</strong> ${data.summary?.tm_checks || 0}</div>
                <div><strong>–§–∞–∫—Ç–æ—Ä–æ–≤ —Ä–∏—Å–∫–∞:</strong> ${data.summary?.risk_factors_count || 0}</div>
            `;

            // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¢–ó
            const tmContent = document.getElementById('tmResultsContent');
            if (data.trademark_results && data.trademark_results.length > 0) {
                let tmHtml = '';
                data.trademark_results.forEach(r => {
                    const statusBadge = r.status === 'red' ? 'bg-danger' :
                                       r.status === 'yellow' ? 'bg-warning' : 'bg-success';
                    tmHtml += `
                        <div class="border rounded p-2 mb-2">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <strong>"${r.text}"</strong>
                                <span class="badge ${statusBadge}">${r.status.toUpperCase()}</span>
                            </div>
                            <small class="text-muted">${r.resource}</small>
                            <div class="small">${r.notes || ''}</div>
                    `;

                    if (r.matches && r.matches.length > 0) {
                        tmHtml += `<table class="table table-sm table-bordered mt-2 mb-0">
                            <thead><tr><th>‚Ññ</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ú–ö–¢–£</th><th>–°—Ç–∞—Ç—É—Å</th><th>–°—Ö–æ–¥—Å—Ç–≤–æ</th></tr></thead>
                            <tbody>`;
                        r.matches.slice(0, 5).forEach(m => {
                            const similarity = m.similarity_score ? Math.round(m.similarity_score * 100) + '%' : '-';
                            const mktuStr = Array.isArray(m.classes) ? m.classes.slice(0, 5).join(', ') : '';
                            tmHtml += `<tr>
                                <td>${m.registration_number || '-'}</td>
                                <td>${m.text || '-'}</td>
                                <td>${mktuStr}</td>
                                <td>${m.status || '-'}</td>
                                <td>${similarity}</td>
                            </tr>`;
                        });
                        tmHtml += '</tbody></table>';
                    }
                    tmHtml += '</div>';
                });
                tmContent.innerHTML = tmHtml;
            } else {
                tmContent.innerHTML = '<div class="text-muted">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≤–∞—Ä–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (—Ç–µ–∫—Å—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω)</div>';
            }

            // OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            const ocrContent = document.getElementById('ocrResultsContent');
            if (data.recognized_texts && data.recognized_texts.length > 0) {
                let ocrHtml = '<ul class="list-group">';
                data.recognized_texts.forEach(t => {
                    ocrHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        "${t.text}"
                        <span class="badge bg-secondary">${t.confidence}%</span>
                    </li>`;
                });
                ocrHtml += '</ul>';
                ocrContent.innerHTML = ocrHtml;
            } else {
                ocrContent.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        –¢–µ–∫—Å—Ç –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –≠—Ç–æ –º–æ–∂–µ—Ç –æ–∑–Ω–∞—á–∞—Ç—å:
                        <ul class="mb-0 mt-2">
                            <li>–ù–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞</li>
                            <li>–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –º–µ–ª–∫–∏–π –∏–ª–∏ –Ω–µ—á–∏—Ç–∞–µ–º—ã–π</li>
                            <li>OCR –º–æ–¥—É–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</li>
                        </ul>
                        <div class="mt-2">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é –≤ –ø–æ–ª–µ –≤—ã—à–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.</div>
                    </div>
                `;
            }

            // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            const searchLinksContent = document.getElementById('searchLinksContent');
            let searchHtml = '';

            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            if (data.image_search_results && data.image_search_results.length > 0) {
                searchHtml += '<div class="mb-3"><strong>üîç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫:</strong></div>';
                searchHtml += '<div class="list-group mb-3">';
                data.image_search_results.forEach(sr => {
                    const statusClass = sr.status === 'red' ? 'list-group-item-danger' :
                                       sr.status === 'yellow' ? 'list-group-item-warning' :
                                       'list-group-item-success';
                    const statusIcon = sr.status === 'red' ? 'üî¥' :
                                      sr.status === 'yellow' ? 'üü°' : 'üü¢';

                    searchHtml += `
                        <div class="list-group-item ${statusClass}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${statusIcon} ${sr.resource}</strong>
                                    <p class="mb-1 small">${sr.notes}</p>
                                    ${sr.total_results > 0 ? `<small class="text-muted">–ù–∞–π–¥–µ–Ω–æ: ${sr.total_results} —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</small>` : ''}
                                </div>
                                ${sr.url ? `<a href="${sr.url}" target="_blank" class="btn btn-sm btn-outline-secondary">–û—Ç–∫—Ä—ã—Ç—å</a>` : ''}
                            </div>
                            ${sr.similar_images && sr.similar_images.length > 0 ? `
                                <div class="mt-2">
                                    <small class="text-muted">–ü–æ—Ö–æ–∂–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</small>
                                    <ul class="small mb-0">
                                        ${sr.similar_images.slice(0, 3).map(img => `
                                            <li><a href="${img.link}" target="_blank">${img.title || img.source || '–°—Å—ã–ª–∫–∞'}</a></li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                searchHtml += '</div>';
                searchHtml += '<hr>';
            }

            // –ó–∞—Ç–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            searchHtml += '<p class="text-muted mb-2">–í—ã–ø–æ–ª–Ω–∏—Ç–µ –æ–±—Ä–∞—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</p>';
            searchHtml += '<div class="d-flex flex-wrap gap-2">';
            if (data.image_search_links) {
                Object.entries(data.image_search_links).forEach(([key, info]) => {
                    searchHtml += `
                        <a href="${info.url}" target="_blank" class="btn btn-outline-primary btn-sm"
                           title="${info.instruction}">
                            <i class="bi bi-box-arrow-up-right me-1"></i>${info.name}
                        </a>
                    `;
                });
            }
            searchHtml += '</div>';
            searchLinksContent.innerHTML = searchHtml;

            // –°—Å—ã–ª–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¢–ó
            const tmLinksContent = document.getElementById('tmLinksContent');
            if (data.trademark_links) {
                let tmLinksHtml = '';
                Object.entries(data.trademark_links).forEach(([name, url]) => {
                    tmLinksHtml += `
                        <a href="${url}" target="_blank" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-box-arrow-up-right me-1"></i>${name}
                        </a>
                    `;
                });
                tmLinksContent.innerHTML = tmLinksHtml;
            }

            // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            const recContent = document.getElementById('recommendationsContent');
            if (data.recommendations && data.recommendations.length > 0) {
                let recHtml = '<ul class="list-group">';
                data.recommendations.forEach(rec => {
                    const icon = rec.startsWith('‚õî') ? 'bi-x-circle text-danger' :
                                rec.startsWith('‚ö†Ô∏è') ? 'bi-exclamation-triangle text-warning' :
                                rec.startsWith('‚úÖ') ? 'bi-check-circle text-success' : 'bi-info-circle';
                    recHtml += `<li class="list-group-item"><i class="bi ${icon} me-2"></i>${rec}</li>`;
                });
                recHtml += '</ul>';
                recContent.innerHTML = recHtml;
            }

            // –§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞
            if (data.risk_factors && data.risk_factors.length > 0) {
                let riskHtml = '<div class="alert alert-warning mt-3"><strong>–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞:</strong><ul class="mb-0 mt-2">';
                data.risk_factors.forEach(f => {
                    const icon = f.severity === 'red' ? 'üî¥' : 'üü°';
                    riskHtml += `<li>${icon} ${f.message}</li>`;
                });
                riskHtml += '</ul></div>';
                recContent.innerHTML += riskHtml;
            }

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function closeImageResults() {
            document.getElementById('imageCheckResults').style.display = 'none';
            currentImageCheckId = null;
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–∞ –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
        function exportImageReport(format) {
            if (!currentImageCheckId) {
                alert('–û—Ç—á—ë—Ç –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –∑–∞–Ω–æ–≤–æ.');
                return;
            }
            window.location.href = `/api/export/image/${currentImageCheckId}/${format}`;
        }

        // –ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—Å—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        async function uploadImages(files) {
            const formData = new FormData();
            for (const file of files) {
                formData.append('files', file);
            }

            document.getElementById('batchProgress').style.display = 'block';

            try {
                const response = await fetch('/api/upload/images', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.error) {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                    document.getElementById('batchProgress').style.display = 'none';
                    return;
                }

                currentSessionId = data.session_id;
                await runBatchCheck(data.session_id);

            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
                document.getElementById('batchProgress').style.display = 'none';
            }
        }

        async function runBatchCheck(sessionId) {
            try {
                const response = await fetch(`/api/check/session/${sessionId}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + data.error);
                    document.getElementById('batchProgress').style.display = 'none';
                    return;
                }

                document.getElementById('batchProgress').style.display = 'none';
                displayBatchResults(data);

            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + error.message);
                document.getElementById('batchProgress').style.display = 'none';
            }
        }

        function displayBatchResults(data) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('statTotal').textContent = data.statistics.total;
            document.getElementById('statRed').textContent = data.statistics.red;
            document.getElementById('statYellow').textContent = data.statistics.yellow;
            document.getElementById('statGreen').textContent = data.statistics.green;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            const statusBadges = {
                'red': '<span class="status-badge status-red">–ó–ê–ü–†–ï–©–ï–ù–û</span>',
                'yellow': '<span class="status-badge status-yellow">–í–ù–ò–ú–ê–ù–ò–ï</span>',
                'green': '<span class="status-badge status-green">–†–ê–ó–†–ï–®–ï–ù–û</span>'
            };

            data.results.forEach(item => {
                const row = document.createElement('tr');
                row.dataset.status = item.status;

                row.innerHTML = `
                    <td>${statusBadges[item.status]}</td>
                    <td><strong>${item.article}</strong></td>
                    <td>${item.name}</td>
                    <td>${Math.round(item.risk_score)}%</td>
                    <td>${item.summary || ''}</td>
                    <td>${(item.recommendations || []).slice(0, 2).join('<br>')}</td>
                `;

                tbody.appendChild(row);
            });

            document.getElementById('resultsContainer').classList.add('show');
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É
        document.getElementById('filterStatus').addEventListener('change', function() {
            const status = this.value;
            const rows = document.querySelectorAll('#resultsTableBody tr');

            rows.forEach(row => {
                if (!status || row.dataset.status === status) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function exportResults(format) {
            if (!currentSessionId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É');
                return;
            }

            window.location.href = `/api/export/${currentSessionId}/${format}`;
        }

        // –ü–∞–∫–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        const multiImageUploadArea = document.getElementById('multiImageUploadArea');
        const multiImageFileInput = document.getElementById('multiImageFileInput');
        let multiImageFiles = [];

        if (multiImageUploadArea && multiImageFileInput) {
            multiImageUploadArea.addEventListener('click', () => multiImageFileInput.click());
            multiImageUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                multiImageUploadArea.classList.add('dragover');
            });
            multiImageUploadArea.addEventListener('dragleave', () => {
                multiImageUploadArea.classList.remove('dragover');
            });
            multiImageUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                multiImageUploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    addMultipleImages(Array.from(e.dataTransfer.files));
                }
            });

            multiImageFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    addMultipleImages(Array.from(e.target.files));
                }
            });
        }

        function addMultipleImages(files) {
            const imageFiles = files.filter(f => f.type.startsWith('image/')).slice(0, 10);
            multiImageFiles = imageFiles;

            const previewArea = document.getElementById('multiImagePreviewArea');
            const actionsArea = document.getElementById('multiImageActions');

            if (imageFiles.length > 0) {
                previewArea.style.display = 'flex';
                actionsArea.style.display = 'block';
                previewArea.innerHTML = '';

                imageFiles.forEach((file, idx) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const col = document.createElement('div');
                        col.className = 'col-md-2 col-sm-3 col-4';
                        col.innerHTML = `
                            <div class="card h-100">
                                <img src="${e.target.result}" class="card-img-top" style="height: 80px; object-fit: cover;">
                                <div class="card-body p-1 text-center">
                                    <small class="text-muted">${file.name.slice(0, 10)}...</small>
                                </div>
                            </div>
                        `;
                        previewArea.appendChild(col);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        function clearMultipleImages() {
            multiImageFiles = [];
            document.getElementById('multiImagePreviewArea').style.display = 'none';
            document.getElementById('multiImageActions').style.display = 'none';
            document.getElementById('multiImageResults').style.display = 'none';
        }

        // –í—ã–±–æ—Ä –ø–∞–ø–∫–∏ —á–µ—Ä–µ–∑ input
        let selectedFolderFiles = [];

        document.getElementById('folderSelectArea').addEventListener('click', () => {
            document.getElementById('folderInput').click();
        });

        document.getElementById('folderInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const imageFiles = files.filter(f =>
                f.type.startsWith('image/') ||
                /\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(f.name)
            );

            if (imageFiles.length === 0) {
                alert('–í –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π');
                return;
            }

            selectedFolderFiles = imageFiles;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ
            const folderName = files[0]?.webkitRelativePath?.split('/')[0] || '–í—ã–±—Ä–∞–Ω–Ω–∞—è –ø–∞–ø–∫–∞';
            document.getElementById('selectedFolderName').textContent =
                `${folderName} (${imageFiles.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)`;
            document.getElementById('selectedFolderInfo').style.display = 'block';

        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ –ø–∞–ø–∫–∏
        async function checkFolderImages() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã –≤—ã–±—Ä–∞–Ω—ã —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥
            if (selectedFolderFiles.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏, –Ω–∞–∂–∞–≤ –Ω–∞ –æ–±–ª–∞—Å—Ç—å –≤—ã—à–µ');
                return;
            }

            await checkSelectedFiles(selectedFolderFiles);
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –≤ base64 –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤, –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥
        async function checkSelectedFiles(files) {
            const progressDiv = document.getElementById('folderProgress');
            const progressBar = document.getElementById('folderProgressBar');
            const progressText = document.getElementById('folderProgressText');
            const resultsDiv = document.getElementById('folderResults');

            progressDiv.style.display = 'block';
            resultsDiv.style.display = 'none';

            let results = [];
            let images = [];  // Base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è Excel
            let stats = { total: files.length, red: 0, yellow: 0, green: 0 };

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const percent = Math.round(((i + 1) / files.length) * 100);
                progressBar.style.width = percent + '%';
                progressBar.textContent = percent + '%';
                progressText.textContent = `–ü—Ä–æ–≤–µ—Ä–∫–∞: ${file.name} (${i + 1}/${files.length})`;

                // –ü–æ–ª—É—á–∞–µ–º base64 –¥–ª—è –ø—Ä–µ–≤—å—é
                let imageBase64 = '';
                try {
                    imageBase64 = await fileToBase64(file);
                } catch (e) {
                    console.log('–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', e);
                }
                images.push(imageBase64);

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch('/api/check/image', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    const status = data.overall_status || 'green';
                    stats[status]++;

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ image_search_results
                    let found_products = [];
                    if (data.image_search_results && data.image_search_results.length > 0) {
                        for (const sr of data.image_search_results) {
                            if (sr.similar_images && sr.similar_images.length > 0) {
                                for (const img of sr.similar_images) {
                                    if (img.link && found_products.length < 5) {
                                        found_products.push({
                                            title: (img.title || '–¢–æ–≤–∞—Ä').substring(0, 50),
                                            link: img.link,
                                            source: img.source || ''
                                        });
                                    }
                                }
                            }
                            if (found_products.length >= 5) break;
                        }
                    }

                    results.push({
                        filename: file.name,
                        status: status,
                        recognized_texts: data.recognized_texts || [],
                        risk_factors: data.risk_factors || [],
                        trademark_matches: data.trademark_results || [],
                        thumbnail: imageBase64,  // –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                        found_products: found_products
                    });
                } catch (error) {
                    stats.yellow++;
                    results.push({
                        filename: file.name,
                        status: 'yellow',
                        recognized_texts: [],
                        risk_factors: [{ message: '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + error.message }],
                        trademark_matches: [],
                        thumbnail: imageBase64,
                        found_products: []
                    });
                }
            }

            progressDiv.style.display = 'none';

            // –°–æ–∑–¥–∞—ë–º Excel –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
            try {
                const response = await fetch('/api/export/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ results, statistics: stats, images })
                });
                const exportData = await response.json();

                displayFolderResults({
                    results,
                    statistics: stats,
                    excel_url: exportData.excel_url
                });
            } catch (e) {
                displayFolderResults({ results, statistics: stats, excel_url: null });
            }

            // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä
            selectedFolderFiles = [];
            document.getElementById('selectedFolderInfo').style.display = 'none';
            document.getElementById('folderInput').value = '';
        }

        function displayFolderResults(data) {
            const resultsDiv = document.getElementById('folderResults');
            resultsDiv.style.display = 'block';

            const stats = data.statistics;
            let html = `
                <div class="alert alert-success">
                    <h5><i class="bi bi-check-circle me-2"></i>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h5>
                    <p class="mb-2">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: <strong>${stats.total}</strong></p>
                    <div class="d-flex gap-3 mb-3">
                        <span class="badge bg-danger fs-6">–ó–∞–ø—Ä–µ—â–µ–Ω–æ: ${stats.red}</span>
                        <span class="badge bg-warning text-dark fs-6">–í–Ω–∏–º–∞–Ω–∏–µ: ${stats.yellow}</span>
                        <span class="badge bg-success fs-6">–†–∞–∑—Ä–µ—à–µ–Ω–æ: ${stats.green}</span>
                    </div>
                    <a href="${data.excel_url}" class="btn btn-success">
                        <i class="bi bi-file-earmark-excel me-1"></i>–°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç Excel
                    </a>
                </div>
            `;

            // –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å –º–∏–Ω–∏–∞—Ç—é—Ä–∞–º–∏
            if (data.results && data.results.length > 0) {
                html += `
                    <div class="table-responsive mt-3">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 80px;">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                                    <th>–§–∞–π–ª</th>
                                    <th>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–†–∏—Å–∫–∏</th>
                                    <th style="width: 200px;">–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                for (const result of data.results) {
                    const statusClass = result.status === 'red' ? 'danger' : result.status === 'yellow' ? 'warning' : 'success';
                    const statusText = result.status === 'red' ? '–ó–∞–ø—Ä–µ—â–µ–Ω–æ' : result.status === 'yellow' ? '–í–Ω–∏–º–∞–Ω–∏–µ' : '–†–∞–∑—Ä–µ—à–µ–Ω–æ';
                    const texts = result.recognized_texts || [];
                    const risks = result.risk_factors || [];
                    const thumbnail = result.thumbnail || '';
                    const products = result.found_products || [];

                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã
                    let productsHtml = '-';
                    if (products.length > 0) {
                        productsHtml = products.slice(0, 5).map((p, i) => {
                            const title = (p.title || '–¢–æ–≤–∞—Ä').substring(0, 30) + (p.title && p.title.length > 30 ? '...' : '');
                            return `<a href="${p.link}" target="_blank" class="d-block text-truncate" style="font-size: 11px;" title="${p.title || '–¢–æ–≤–∞—Ä'}">${i+1}. ${title}</a>`;
                        }).join('');
                    }

                    html += `
                        <tr>
                            <td>
                                ${thumbnail ? `<img src="${thumbnail}" alt="${result.filename}" style="max-width: 60px; max-height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer;" onclick="showImageModal('${thumbnail}', '${result.filename}')">` : '<span class="text-muted">-</span>'}
                            </td>
                            <td><small>${result.filename}</small></td>
                            <td><small>${texts.map(t => t.text || t).join(', ') || '-'}</small></td>
                            <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                            <td><small>${risks.length > 0 ? risks.map(r => r.message || r).join('; ') : '-'}</small></td>
                            <td>${productsHtml}</td>
                        </tr>
                    `;
                }
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;
        }

        async function checkMultipleImages() {
            if (multiImageFiles.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                return;
            }

            const resultsDiv = document.getElementById('multiImageResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div class="alert alert-info"><div class="spinner-border spinner-border-sm me-2"></div>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π... 0/' + multiImageFiles.length + '</div>';

            let results = [];
            for (let i = 0; i < multiImageFiles.length; i++) {
                const file = multiImageFiles[i];
                resultsDiv.innerHTML = `<div class="alert alert-info"><div class="spinner-border spinner-border-sm me-2"></div>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π... ${i + 1}/${multiImageFiles.length}</div>`;

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch('/api/check/image', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    results.push({
                        filename: file.name,
                        ...data
                    });
                } catch (error) {
                    results.push({
                        filename: file.name,
                        error: error.message,
                        overall_status: 'yellow'
                    });
                }
            }

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            displayMultiImageResults(results);
        }

        function displayMultiImageResults(results) {
            const resultsDiv = document.getElementById('multiImageResults');

            let html = '<h5>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏</h5>';
            html += '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr><th>–°—Ç–∞—Ç—É—Å</th><th>–§–∞–π–ª</th><th>–¢–µ–∫—Å—Ç—ã</th><th>–ü—Ä–æ–±–ª–µ–º—ã</th></tr></thead>';
            html += '<tbody>';

            results.forEach(r => {
                const statusClass = r.overall_status === 'red' ? 'status-red' :
                                   r.overall_status === 'yellow' ? 'status-yellow' : 'status-green';
                const statusLabel = r.overall_status === 'red' ? '–ó–ê–ü–†–ï–©–ï–ù–û' :
                                   r.overall_status === 'yellow' ? '–í–ù–ò–ú–ê–ù–ò–ï' : '–†–ê–ó–†–ï–®–ï–ù–û';

                const texts = r.recognized_texts ? r.recognized_texts.map(t => t.text).join(', ') : '-';
                const problems = r.risk_factors ? r.risk_factors.length : 0;

                html += `<tr>
                    <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                    <td>${r.filename}</td>
                    <td>${texts.slice(0, 50)}${texts.length > 50 ? '...' : ''}</td>
                    <td>${problems > 0 ? '<span class="badge bg-danger">' + problems + '</span>' : '<span class="badge bg-success">0</span>'}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const redCount = results.filter(r => r.overall_status === 'red').length;
            const yellowCount = results.filter(r => r.overall_status === 'yellow').length;
            const greenCount = results.filter(r => r.overall_status === 'green').length;

            html = `
                <div class="row mb-3">
                    <div class="col-md-4"><div class="alert alert-danger mb-0 text-center"><strong>${redCount}</strong> –∑–∞–ø—Ä–µ—â–µ–Ω–æ</div></div>
                    <div class="col-md-4"><div class="alert alert-warning mb-0 text-center"><strong>${yellowCount}</strong> —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div></div>
                    <div class="col-md-4"><div class="alert alert-success mb-0 text-center"><strong>${greenCount}</strong> —Ä–∞–∑—Ä–µ—à–µ–Ω–æ</div></div>
                </div>
            ` + html;

            resultsDiv.innerHTML = html;
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function showImageModal(src, filename) {
            // –°–æ–∑–¥–∞—ë–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç
            let modal = document.getElementById('imagePreviewModal');
            if (!modal) {
                const modalHtml = `
                    <div class="modal fade" id="imagePreviewModal" tabindex="-1">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="imagePreviewTitle">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body text-center p-0">
                                    <img id="imagePreviewImg" src="" alt="" style="max-width: 100%; max-height: 70vh;">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                modal = document.getElementById('imagePreviewModal');
            }

            document.getElementById('imagePreviewTitle').textContent = filename;
            document.getElementById('imagePreviewImg').src = src;
            new bootstrap.Modal(modal).show();
        }
    </script>
</body>
</html>
